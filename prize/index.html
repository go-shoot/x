<title>陀螺景品⬧Prizes</title>
<script src=../include/common.js></script>
<script src=https://aeoq.github.io/diamond-grid/script.js type=module></script>
<link rel=stylesheet href=prize.css>

<nav>
    <menu>
        <li><a href="../products/" data-icon=""></a>
        <li><a href="../parts/?blade" data-icon=""></a>
    </menu>
    <a href="https://beyblade.takaratomy.co.jp/beyblade-x/news/news_stickerlist.html" title="各款貼紙"></a>
    <form class="LED"></form>
</nav>

<main>
    <diamond-grid class="loading"></diamond-grid>
</main>

<script type="module">
import { Bey } from '../include/bey.js'
import { FilterForm, Keihin } from '../include/utilities.js'

const Prize = () => Prize.before().then(Prize.display).then(Prize.after);
Object.assign(Prize, {
    before: () => Promise.all([DB.get.essentials(), DB.get('product', 'keihins')])
        .then(([[meta, parts], keihins]) => Bey.import(meta.general, parts) && keihins),

    display: keihins => Q('diamond-grid').append(...Prize.all = keihins.map(k => new Keihin(k))),
    after () {
        Prize.filter();
        Prize.event();
        Q('.loading').classList.remove('loading');
    },
    filter: () => Q('nav form').append(
        new FilterForm.fieldset(Prize.icons, {name: 'type'}), 
        new FilterForm.fieldset(Prize.lines, {name: 'line', negate: true})
    ),
    event () {
        FilterForm.event(Prize.all);
        onclick = ev => {
            let h4 = ev.target.closest('h4')?.cloneNode(true);
            if (!h4) return;
            h4.Q('code')?.remove();
            navigator.clipboard.writeText([...h4.children].map(el => el.innerText.replace(' ', '')).join(' '));
        }
        onhashchange = () => Q(`[id='${location.hash.substring(1)}']`)?.scrollIntoView();
    },
    icons: new O({'keihin-m': '\ue001', 'keihin-g': '\ue002', 'keihin-d': '\ue02f', 'keihin-t': '\ue031'}),
    lines: new O(Storage('line')).map(([line]) => [line, E('img', {src: `../img/lines.svg#${line}`})]),
});
Q('main').prepend(DB().then(Prize));
</script>
