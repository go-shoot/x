<title>非官方資訊站⬧Unofficial site</title>
<meta name=description content="最新日本陀螺情報、所有部件圖鑑、限量産品，都一應俱全。">
<script defer src=include/common.js></script>
<link rel=stylesheet href=index.css>
<link rel=stylesheet href=include/component.css>
<img src="https://beyblade.takaratomy.co.jp/anime/_image/kv_chara.png" hidden>
<video src="./bg.mp4" muted autoplay></video><video src="./bg.mp4" muted></video>

<input>

<header>
    <h1 hidden>戰鬥陀螺 X⬧爆旋陀螺 X⬧ベイブレード X⬧Beyblade X</h1>
    <img src="https://beyblade.takaratomy.co.jp/_image/cmn_logo.svg" alt="戰鬥陀螺 X⬧爆旋陀螺 X⬧ベイブレード X⬧Beyblade X">
    <h2>非官方資訊站</h2>
</header>

<section id="search">
    <search>
        <a href=products/ > 商品</a>
        <a href=parts/ > 部件</a>
        <a href=prize/ > 景品</a>
        <a href="customize/sheet.html"> 設計器</a>
        <input type="search">
    </search>
    <ol class="parts"></ol>
    <ol class="beys"></ol>
    <ol class="links"></ol>
</section>

<section id=products><h3>最新商品</h3></section>

<section id=reboot>
    如在本網遇上問題<div><i id=reset>&#xe010;</i><span>重設儲存</span><i></i></div>
    <a href="../"><img src="../25th.png"></a>
</section>

<footer>
    對於本網所載資料的準確性或完整性，製作者不會作任何保證或聲明，或因提供或使用此網資料而直接或間接引致的任何損失、損壞或傷害，負上任何責任。
    <br>Developed and Designed by V Man (MKK). 2023–.
</footer>

<link rel="stylesheet" href="include/part.css">

<script type="module">
import DB from './include/DB.js'
import {Markup, Preview} from './include/bey.js'
import {Part} from './include/part.js'
import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js@7.1.0/dist/fuse.min.mjs'
let CACHE;
Q('[type=search]').oninput = ev => {
    Preview.reset();
    if (!ev.target.value.trim()) return;

    const link = ([comp, line, group], title, label) => ({                        
        keywords: ["零件","部件","組件","圖鑑", ...title.split(/[【⬧】]/)],
        href: `parts/?${comp}${line ? `=${line}` : ''}${group ? `#${group}` : ''}`, 
        text: (label || title).match(/[一-龥]+⬧?[一-龥]+/)?.[0] || label || title
    });
    (CACHE ? Promise.resolve() : 
        Promise.all([DB.get.essentials(false), DB.get('meta', 'search'), DB.get('product', 'beys')])
        .then(([[meta, parts], links, beys]) => {            
            links.push(...[...meta.grouped].map(([comp, obj]) => [
                link([comp], (obj.所有 ?? obj.一體).title),
                [...obj].filter(([, obj]) => obj.group).map(([line, obj]) => line.endsWith('X') ? 
                    [...obj.title].map(([group, title]) => link([comp, line, group], title)) : 
                    [...obj.group].map(([group, {label}]) => link([comp, , group], obj.title, label))
                )
            ]).flat(9));
            beys = beys.map(([code]) => code);
            let max = new O([...new Set(beys.map(code => code.split('-')[0]))]
                .map(line => [line, beys.find(code => new RegExp(`^${line}-`).test(code))?.match(/\d+/)[0]]));
            CACHE = {links, max};
            return Promise.all(parts.flatMap(([, parts]) => parts.map(p => new Part(p).revise())));
        })
        .then(parts => CACHE.parts = parts.map(p => p.push({all: [...p].flat()})) )
    ).then(() => {
        let search = Markup.replace(ev.target.value, 'search').trim();
        Q('#search .parts').replaceChildren(...new Fuse(CACHE.parts, {keys: ['abbr', 'all'], threshold: .35})
            .search({$or: [
                {abbr: search}, {$and: search.split(/(?=\W)/).map(t => ({all: t}) )}
            ]})
            .map(({item}) => E(`li>button.${item.comp}.${item.line || item.group}`, 
                Markup('cell', item.names?.chi || item.abbr),
                {onclick: () => new Preview(['tile', 'cell'], item.path)}
            ))
        );
        Q('#search .links').replaceChildren(...new Fuse(CACHE.links, {keys: ['keywords', 'text'], threshold: .4})
            .search(search).slice(0, 5)
            .map(({item}) => E('li>a', item.text, {
                classList: /(?<=parts\/\?).+?(?=[=#])/.exec(item.href)?.[0] || '',
                href: item.href, target: item.href.startsWith('//') ? '_blank' : ''
            }))
        );
        Q('#search .beys').replaceChildren(/^[a-z]x[a-z]?-?\d{2,3}$/i.test(search) 
            && (search = search.toUpperCase().replace(/([A-Z]+)(\d+)/, '$1-$2'))
            && (([line, no]) => parseInt(no) <= parseInt(CACHE.max[line]))(search.split('-')) ? 
            E('li>button', search, {onclick: () => new Preview(['cell', 'image'], search)}) : ''
        );
    })
}

import {Shohin} from './include/utilities.js'
import PointerInteraction from 'https://aeoq.github.io/pointer-interaction/script.js';
const plugins = {
    announce: news => new O(news).each(([date, beys]) => 
        Q('#products').append(E('time', {title: date}), ...beys.map(bey => new Shohin(bey)))
    ),
    followup: () => DB.get.essentials()
        .then(([meta, parts]) => Part.import(meta.general, parts))
        .then(() => Shohin.after())
};
Q('header').after(DB(plugins).then(() => {
    const observer = new IntersectionObserver(entries => entries.forEach(entry => 
        entry.target.classList.toggle('seeing', entry.isIntersecting)
    ));
    Q('header,section,time,.scroller', el => observer.observe(el));
    const reset = message => Promise.all([
        DB.discard(ev => message.innerText = ev.type == 'blocked' ? '請先關閉所有本網的分頁' : ev.type),
        caches.delete('V4'), caches.delete('parts'),
        localStorage.clear(),
        navigator.serviceWorker.getRegistrations().then(([reg]) => reg.unregister())
    ]);
    PointerInteraction.events({
        '.scroller,#search ol': {scroll: {x: true}},
        '#reset': {
            drop: {goal: 'i:last-child'},
            drag: PI => PI.drag.to.translate({x: {
                min: 0, max: Q('#reboot div').clientWidth - Q('#reset').clientWidth
            }, y: false}),
            lift: PI => PI.goal && reset(PI.target.nextElementSibling).then(() => {
                onbeforeunload = () => scrollTo(0, 0);
                location.reload();
            }).catch(er => console.error(er)),
        }
    });
}));

(new Date - Storage('cached'))/1000/60/60/24 > 30 && fetch('sw/?delete=parts');

Q('body>input').onkeypress = ev => {
    if ((ev.keyCode || ev.which) != 13) return;
    ev.target.value = ev.target.value.trim();
    if (/^i#.+$/i.test(ev.target.value))
        return location.href = `https://instagram.com/explore/tags/${/(?<=#).+/.exec(ev.target.value)}`;
    if (/^i@.+$/i.test(ev.target.value))
        return location.href = `https://instagram.com/${/(?<=@).+/.exec(ev.target.value)}`;
    if (/^x\?.+$/i.test(ev.target.value))
        return location.href = `https://x.com/search?q=${/(?<=\?).+/.exec(ev.target.value)}&f=live`;
    if (/^x#.+$/i.test(ev.target.value))
        return location.href = `https://x.com/hashtag/${/(?<=#).+/.exec(ev.target.value)}/?f=live`;
    if (/^t\?.+$/i.test(ev.target.value))
        return location.href = `https://www.threads.net/search?q=${/(?<=\?).+/.exec(ev.target.value.replace('#', '%23'))}`;
    return location.href = `https://${ev.target.value}`;
}

let swapped, sec = 1;
Q('video', video => E(video).set({
    '--crossfade': sec,
    ontimeupdate: ev => {
        if (swapped || ev.target.duration - ev.target.currentTime > sec) return;
        let next = ev.target.autoplay ? ev.target.nextElementSibling : ev.target.previousElementSibling;
        next.play();
        next.style.opacity = 1;
        ev.target.style.opacity = 0;
        swapped = true;
        setTimeout(() => swapped = false, 1000 * sec);
    }
}));
</script>
